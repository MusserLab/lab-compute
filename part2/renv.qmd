# R: rig & renv

In [Your First R Project](../part1/first-project.qmd), you ran `renv::init()`, installed packages, and ran `renv::snapshot()` to lock your environment. This chapter explains what those commands actually do under the hood, and covers rig for managing R versions alongside renv for packages.

Managing R effectively requires two things: controlling which **version of R** you're running, and controlling which **packages** are installed for each project. We use **rig** for the former and **renv** for the latter. Together, they give you the same isolation and reproducibility that conda provides for Python.

## Why This Matters

Without version management:

- You update R for one project and break another that depended on the old version
- A collaborator has R 4.3 while you have R 4.4, and Bioconductor packages behave differently
- All your projects share one package library—updating `ggplot2` for Project A might break Project B

With rig + renv:

- Multiple R versions coexist on your machine
- Each project specifies which R version it needs
- Each project has its own package library with versions locked in `renv.lock`
- Anyone can recreate your exact environment

## rig: Managing R Versions

rig (R Installation Manager) lets you install, switch between, and manage multiple R versions from the command line. The [Installation chapter](../part1/installation.qmd) covers how to install rig itself; this section covers day-to-day usage.

### Why Multiple R Versions?

You might need multiple R versions when:

- **Collaborating**: A collaborator's project uses R 4.3, but your default is R 4.4
- **Bioconductor compatibility**: Bioconductor versions are tied to specific R versions (see [Bioconductor section](#bioconductor) below)
- **Legacy projects**: An older analysis needs to run exactly as it did originally
- **Testing**: You want to verify code works across R versions before sharing

### Essential rig Commands

```bash
# List installed R versions
rig list

# Install the latest stable R
rig add release

# Install a specific version
rig add 4.3

# Set the system default
rig default 4.4

# See which version is default
rig default
```

::: {.callout-note}
## rig add vs. CRAN installers
When you run `rig add`, it downloads and installs R without removing previous versions. This is different from downloading R directly from CRAN, which typically overwrites your existing installation.
:::

### Setting R Version Per Project

For reproducibility, you can lock a specific R version to a project so that Positron always uses it, regardless of your system default. Add this to `.vscode/settings.json` in your project:

::: {.panel-tabset}

### macOS (Apple Silicon)
```json
{
  "r.rpath.mac": "/Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/bin/R"
}
```

### macOS (Intel)
```json
{
  "r.rpath.mac": "/Library/Frameworks/R.framework/Versions/4.4-x86_64/Resources/bin/R"
}
```

### Windows
```json
{
  "r.rpath.windows": "C:\\Program Files\\R\\R-4.4.0\\bin\\R.exe"
}
```

:::

You can also set this interactively: open the Command Palette in Positron (**Cmd+Shift+P** / **Ctrl+Shift+P**) and select **R: Select R Binary**. See the [Positron chapter](positron.qmd#setting-the-r-version) for more details.

## renv: Project Package Libraries

renv creates isolated package libraries for each project. Instead of all projects sharing your user library, each project gets its own `renv/library/` folder with exactly the packages it needs.

### The Workflow

The renv workflow has four steps:

1. **Initialize** renv in your project (`renv::init()`)
2. **Install** packages as you work (`install.packages()` or `renv::install()`)
3. **Snapshot** to record what you installed (`renv::snapshot()`)
4. **Restore** on another machine or after cloning (`renv::restore()`)

### Initialize renv

In a new or existing R project:

```r
# Install renv if needed (only once per R installation)
install.packages("renv")

# Initialize renv for this project
renv::init()
```

This creates:

| File/Folder | Purpose |
|-------------|---------|
| `renv/` | Local package library (packages installed here) |
| `renv.lock` | Lockfile recording exact package versions |
| `.Rprofile` | Activates renv automatically when R starts |
| `renv/activate.R` | The activation script |

When you open the project in Positron and start R, you'll see:

```
- Project '/path/to/project' loaded. [renv 1.0.0]
```

This confirms renv is active.

### Installing Packages

With renv active, install packages as usual:

```r
# Install from CRAN
install.packages("ggplot2")

# Install multiple packages
install.packages(c("dplyr", "tidyr", "readr"))
```

For more control, use `renv::install()`:

```r
# Install from GitHub
renv::install("tidyverse/ggplot2")

# Install a specific version
renv::install("ggplot2@3.4.0")

# Install from Bioconductor (after setting up BiocManager)
renv::install("bioc::DESeq2")
```

### Snapshot

After installing or updating packages, save the current state:

```r
renv::snapshot()
```

This updates `renv.lock` with the exact versions of all packages in your project library. **Always snapshot after installing packages**, and commit the updated `renv.lock` to Git.

### Restore

When you clone a project or set it up on a new machine:

```r
renv::restore()
```

This reads `renv.lock` and installs every package at the exact version recorded. This is how collaborators reproduce your environment.

### Status

Check whether your library matches the lockfile:

```r
renv::status()
```

This tells you if packages are:

- Missing from the library (need `renv::restore()`)
- Installed but not in the lockfile (need `renv::snapshot()`)
- Different versions than the lockfile

Run `renv::status()` before committing to ensure your lockfile is current.

::: {.callout-warning title="Claude Code"}
Claude Code can interpret renv status messages and tell you whether to `restore()` or `snapshot()`.

> I'm getting `Project 'my-project' is out-of-sync` when I start R. Here's the output of `renv::status()`: [paste output]. Should I restore or snapshot?

Claude will read the status output, explain which packages are out of sync and why, and recommend the right command.
:::

## Core R Packages

### The tidyverse {#tidyverse}

The tidyverse is a collection of R packages that share a common design philosophy centered on "tidy data"—rectangular data where each variable is a column, each observation is a row, and each value is a cell. This simple principle, combined with a consistent and expressive syntax, has made the tidyverse the standard toolkit for data analysis in R.

What makes the tidyverse transformative is that it provides a unified grammar for the entire data analysis pipeline: importing data, reshaping it, transforming it, visualizing it, and communicating results. The packages are designed to work together seamlessly, with consistent naming conventions and compatible data structures. Code written in tidyverse style tends to be readable and self-documenting—you can often understand what a pipeline does just by reading it.

The tidyverse occupies the same role in R that pandas does in Python: both represent the modern, dataframe-centric approach to data manipulation. While they developed somewhat independently (pandas emerged around 2008, dplyr in 2014), they share the philosophy that most data analysis tasks involve filtering rows, selecting columns, creating new variables, grouping, and summarizing. If you learn one well, the concepts transfer to the other.

The core tidyverse packages are:

| Package | Purpose |
|---------|---------|
| `dplyr` | Data manipulation: filter rows, select columns, create new variables, summarize, join tables |
| `ggplot2` | Visualization using the grammar of graphics |
| `tidyr` | Reshape data: pivot between wide and long formats |
| `readr` | Fast, consistent data import (read_csv, read_tsv, etc.) |
| `purrr` | Functional programming: apply functions across lists and vectors |
| `stringr` | String manipulation with consistent syntax |

Loading the tidyverse meta-package loads all of these at once:

```r
library(tidyverse)
```

::: {.callout-tip}
## Learning the tidyverse
This guide assumes basic familiarity with tidyverse syntax. If you're new to R or transitioning from base R, work through [R for Data Science](https://r4ds.hadley.nz/) by Hadley Wickham, Mine Çetinkaya-Rundel, and Garrett Grolemund. It's the definitive resource for learning modern R workflows.
:::

### Other Essential Packages

| Package | Purpose |
|---------|---------|
| `here` | Build file paths relative to the project root—essential for reproducible scripts |
| `knitr` | Required for rendering Quarto documents with R code |

## Bioconductor {#bioconductor}

Bioconductor is a specialized repository of R packages for bioinformatics and computational biology. It's separate from CRAN and has its own installation system, release schedule, and quality standards. If you're doing genomics, transcriptomics, or single-cell analysis in R, you'll use Bioconductor packages extensively.

### What Makes Bioconductor Different

**Curated and reviewed**: Packages undergo technical review before acceptance and must meet documentation and testing standards.

**Coordinated releases**: All Bioconductor packages are released together twice per year, tested against each other for compatibility.

**Specialized data structures**: Bioconductor defines standard classes for genomic data (`SummarizedExperiment`, `SingleCellExperiment`, etc.) that packages use consistently.

**Tied to R versions**: Each Bioconductor release requires a specific R version. This is important for reproducibility.

### Installing Bioconductor Packages

Bioconductor packages are installed via `BiocManager`, not `install.packages()`:

```r
# First, install BiocManager (only once)
install.packages("BiocManager")

# Then install Bioconductor packages
BiocManager::install("DESeq2")
BiocManager::install(c("limma", "edgeR", "tximport"))

# Don't forget to snapshot
renv::snapshot()
```

renv automatically detects Bioconductor packages and records them correctly in the lockfile.

### Bioconductor Version Synchronization {#bioc-versions}

Bioconductor versions are tied to R versions:

| Bioconductor | R Version | Release Date |
|--------------|-----------|--------------|
| 3.18 | R 4.3.x | Oct 2023 |
| 3.19 | R 4.4.x | May 2024 |
| 3.20 | R 4.4.x | Oct 2024 |
| 3.21 | R 4.5.x | May 2025 |

**Why this matters**: If you developed an analysis with R 4.3 and Bioconductor 3.18, a collaborator with R 4.4 will get Bioconductor 3.19 or 3.20—potentially with different package behaviors. For critical analyses, pin the R version in your project settings (see [Setting R Version Per Project](#setting-r-version-per-project) above).

Check your current Bioconductor version:

```r
BiocManager::version()
```

::: {.callout-note}
## Bioconductor and renv
When you use renv, the Bioconductor version is recorded in `renv.lock` along with package versions. Running `renv::restore()` on a new machine will install packages from the same Bioconductor release, helping ensure reproducibility.
:::

### RNA-seq Analysis Packages

These packages form the core toolkit for bulk RNA-seq differential expression analysis:

| Package | Purpose |
|---------|---------|
| `DESeq2` | Differential expression using negative binomial generalized linear models. The most widely used method. |
| `limma` | Linear models for differential expression. Includes `voom` for RNA-seq count data. Fast and flexible. |
| `edgeR` | Differential expression using empirical Bayes estimation. Similar approach to DESeq2. |
| `tximport` | Import transcript-level quantifications from Salmon, kallisto, or RSEM into gene-level counts. |
| `tximeta` | Like tximport but automatically attaches metadata about the reference transcriptome. |
| `goseq` | Gene Ontology enrichment analysis that accounts for gene length bias in RNA-seq data. |

A typical RNA-seq analysis workflow uses `tximport` or `tximeta` to import quantifications, then `DESeq2` (or `limma`/`edgeR`) for differential expression, then `goseq` for pathway analysis.

### Single-Cell Analysis Packages

Single-cell RNA-seq requires specialized methods. These are the main packages:

| Package | Purpose |
|---------|---------|
| `Seurat` | Comprehensive toolkit for single-cell analysis: QC, normalization, clustering, visualization, integration across datasets. The most popular choice. |
| `SingleCellExperiment` | Bioconductor's standard data structure for single-cell data. Many packages use this format. |
| `scran` | Normalization (pooling-based), feature selection, and clustering methods from the Bioconductor ecosystem. |
| `scater` | Quality control, visualization, and preprocessing. Works with SingleCellExperiment objects. |
| `Monocle3` | Trajectory analysis and pseudotime inference—modeling how cells transition between states. |

::: {.callout-note}
## Seurat vs. Bioconductor ecosystem
Seurat is the most popular single-cell package but isn't part of Bioconductor—it's on CRAN (and GitHub). The Bioconductor single-cell packages (`SingleCellExperiment`, `scran`, `scater`) form an alternative ecosystem. Many workflows use both: Seurat for analysis and visualization, with conversion to `SingleCellExperiment` when needed for specific Bioconductor tools.
:::

## Installing from Other Sources

### GitHub Packages

For development versions or packages not on CRAN:

```r
# Install from GitHub
renv::install("satijalab/seurat")

# Install a specific branch
renv::install("satijalab/seurat@develop")

# Install a specific commit
renv::install("satijalab/seurat@abc1234")
```

### Specific Versions

```r
# Install exact version from CRAN
renv::install("dplyr@1.1.0")

# Install exact version from Bioconductor
renv::install("bioc::DESeq2@1.40.0")
```

### Local Packages

```r
# Install from a local directory
renv::install("/path/to/local/package")
```

## The Lockfile

`renv.lock` is a JSON file that records every package, its version, and its source:

```json
{
  "R": {
    "Version": "4.4.1",
    "Repositories": [
      {
        "Name": "CRAN",
        "URL": "https://cloud.r-project.org"
      }
    ]
  },
  "Bioconductor": {
    "Version": "3.19"
  },
  "Packages": {
    "DESeq2": {
      "Package": "DESeq2",
      "Version": "1.44.0",
      "Source": "Bioconductor"
    },
    "ggplot2": {
      "Package": "ggplot2",
      "Version": "3.5.0",
      "Source": "Repository"
    }
  }
}
```

The lockfile records:

- R version used
- Bioconductor version (if applicable)
- Every package with exact version and source

**Always commit `renv.lock` to Git.** This is how collaborators (and future you) reproduce your environment.

## What to Commit to Git

**Include in Git:**

- `renv.lock` — Package versions (this is the important one)
- `renv/activate.R` — Activation script
- `.Rprofile` — Auto-activation on R startup

**Exclude from Git** (add to `.gitignore`):

- `renv/library/` — The actual installed packages (too large, platform-specific)
- `renv/staging/` — Temporary files during installation

The default renv setup handles this correctly. If you used the `.gitignore` from the [Setting Up a Lab Project](../part3/setup-walkthrough.qmd) chapter, these exclusions are already in place.

## Updating Packages

### Update All Packages

```r
renv::update()
renv::snapshot()  # Don't forget!
```

### Update Specific Package

```r
renv::update("ggplot2")
renv::snapshot()
```

### Revert After a Bad Update

If an update breaks something, restore the previous state:

```r
renv::restore()
```

This reinstalls packages at the versions in `renv.lock`, effectively undoing the update. (This is why we snapshot and commit before updating.)

## Best Practices

### Snapshot After Installing

Every time you install or update packages:

```r
renv::snapshot()
```

Then commit the updated `renv.lock`:

```bash
git add renv.lock
git commit -m "Add ggplot2 package"
```

### Check Status Before Committing

```r
renv::status()
```

Ensure your lockfile reflects your actual installed packages before pushing to GitHub.

### Document Non-Standard Installations

If packages require special installation steps (GitHub, specific versions, etc.), document them in your README:

```markdown
## Setup

After cloning, restore the R environment:

```r
renv::restore()
```

Note: `custompackage` is installed from GitHub:
```r
renv::install("username/custompackage")
```
```

### Pin R Version for Critical Projects

For analyses that need to be reproducible long-term (publication-associated code), pin the R version in `.vscode/settings.json` and document it in your README.

## Troubleshooting

### "The project is out-of-sync"

This warning means packages in your library don't match `renv.lock`:

```r
# See what's different
renv::status()

# Option 1: Sync library to lockfile (discard local changes)
renv::restore()

# Option 2: Update lockfile to match library (keep local changes)
renv::snapshot()
```

### Package Installation Fails

Try rebuilding from source:

```r
renv::install("package-name", rebuild = TRUE)
```

For Bioconductor packages, ensure BiocManager is installed and your R version is compatible.

### Bioconductor Version Mismatch

If you see warnings about Bioconductor version mismatches:

```r
# Check your Bioconductor version
BiocManager::version()

# Check what version renv expects
renv::lockfile_read()$Bioconductor$Version
```

If they differ, you may need to update your R version to match, or update the lockfile to use the Bioconductor version for your current R.

### renv is Slow

The first `renv::restore()` on a new machine downloads all packages, which takes time. Subsequent operations use a global cache, so packages shared across projects only download once.

### Starting Fresh

If things are really broken:

```r
# Deactivate renv
renv::deactivate()

# Remove renv files (in terminal)
# rm -rf renv renv.lock .Rprofile

# Reinitialize
renv::init()
```

::: {.callout-warning}
This removes your lockfile. If you need to preserve the package versions, copy `renv.lock` somewhere safe before deleting.
:::

## Quick Reference

### rig Commands

| Task | Command |
|------|---------|
| List installed R versions | `rig list` |
| Install latest R | `rig add release` |
| Install specific version | `rig add 4.3` |
| Set default R | `rig default 4.4` |
| Show default R | `rig default` |

### renv Commands

| Task | Command |
|------|---------|
| Initialize renv | `renv::init()` |
| Install from CRAN | `install.packages("pkg")` |
| Install from GitHub | `renv::install("user/repo")` |
| Install from Bioconductor | `BiocManager::install("pkg")` |
| Snapshot | `renv::snapshot()` |
| Restore | `renv::restore()` |
| Check status | `renv::status()` |
| Update all packages | `renv::update()` |
| Update one package | `renv::update("pkg")` |